<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GootV2 Music Player</title>
  <style>
    :root{
      --primary-bg:#0a1931;
      --secondary-bg:#10264d;
      --accent:#1e90ff;
      --teal:#2ad3c9;
      --text-light:#e0e8ff;
      --text-muted:#9fb3d6;
    }

    body{
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(160deg,var(--primary-bg),var(--secondary-bg));
      color:var(--text-light);
      margin:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:20px;
      min-height:100vh;
    }

    h2{
      margin:8px 0;
      color:var(--accent);
    }

    .breadcrumbs{
      margin:8px 0;
    }

    .breadcrumbs button{
      background:none;
      border:none;
      color:var(--accent);
      cursor:pointer;
      font-size:14px;
      padding:4px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:15px;
      width:100%;
      max-width:900px;
      margin-top:10px;
    }

    .folder{
      background:var(--secondary-bg);
      border-radius:12px;
      padding:15px;
      text-align:center;
      cursor:pointer;
      transition:transform .15s, background .15s;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--text-light);
      user-select:none;
    }

    .folder:hover{ transform:scale(1.04); background:#153672; }

    .playlist{
      list-style:none;
      padding:0;
      width:100%;
      max-width:900px;
      margin-top:20px;
      background:var(--secondary-bg);
      border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.4);
      margin-bottom:120px; /* room for fixed player */
    }

    .playlist li{
      padding:10px 15px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      cursor:pointer;
      color:var(--text-light);
      transition:background .12s;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .playlist li:hover{ background:#1b3361; }

    .playlist li.active{ background:var(--accent); color:white; font-weight:700; }

    /* selection highlight (teal) */
    .playlist li.selected{
      background: linear-gradient(90deg, rgba(42,211,201,0.12), rgba(42,211,201,0.06));
      border-left:4px solid var(--teal);
      color:var(--text-light);
    }

    .player-bar{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#091528;
      border-top:2px solid var(--accent);
      padding:10px 20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      box-shadow:0 -4px 12px rgba(0,0,0,0.45);
      z-index:1000;
    }

    audio{ width:100%; max-width:900px; border-radius:10px; background:var(--secondary-bg); }

    .controls{ margin-top:8px; display:flex; gap:10px; align-items:center; }

    .controls button{
      background:var(--accent);
      color:white;
      border:none;
      border-radius:6px;
      padding:6px 12px;
      cursor:pointer;
      transition:background .12s;
    }

    .controls button.secondary{
      background:transparent;
      border:1px solid rgba(255,255,255,0.08);
      color:var(--text-light);
    }

    .controls button:hover{ filter:brightness(1.06); }

    footer{
      margin-top:40px;
      font-size:13px;
      text-align:center;
      color:var(--text-muted);
      width:100%;
      max-width:900px;
    }

    footer a{ color:var(--accent); text-decoration:none; }
    footer a:hover{ text-decoration:underline; }

    #importInput{ display:none; }
  </style>
</head>
<body>
  <h2>GootV2</h2>

  <div class="breadcrumbs" id="breadcrumbs"></div>

  <div class="grid" id="folderGrid"></div>

  <ul class="playlist" id="playlist"></ul>

  <div class="player-bar" role="region" aria-label="Player">
    <audio id="audioPlayer" controls></audio>
    <div class="controls">
      <button id="savePlaylistBtn">Save Playlist</button>
      <button id="loadPlaylistBtn" class="secondary">Load Playlist</button>
      <button id="clearSelectionBtn" class="secondary" style="display:none">âœ– Clear</button>
      <input id="importInput" type="file" accept=".goot" />
    </div>
  </div>

  <footer>
    <p>For song requests or issues please fill out this form:<br>
      <a href="https://forms.gle/cKjAvKf6PGCTWKUU9" target="_blank" rel="noopener noreferrer">
        https://forms.gle/cKjAvKf6PGCTWKUU9
      </a>
    </p>
    <p><em>GootV2 playback may be unreliable; resolved by waiting it out.</em></p>
  </footer>

  <script>
    // ---------- CONFIG ----------
    const API_KEY = "AIzaSyBi2cvmJYslrUkBNU3U577IDwvToUQqCQo";         // â† replace
    const ROOT_FOLDER_ID = "1kje6wQMhMxvuI-2eYsAMVvs09JYLDo2s"; // â† replace
    // ----------------------------

    const folderGrid = document.getElementById("folderGrid");
    const playlistEl = document.getElementById("playlist");
    const audioPlayer = document.getElementById("audioPlayer");
    const breadcrumbs = document.getElementById("breadcrumbs");
    const saveBtn = document.getElementById("savePlaylistBtn");
    const loadBtn = document.getElementById("loadPlaylistBtn");
    const clearSelBtn = document.getElementById("clearSelectionBtn");
    const importInput = document.getElementById("importInput");

    let folderStack = [{ id: ROOT_FOLDER_ID, name: "Home" }];
    let currentSongs = []; // array of { id, name }
    let currentTrackIndex = -1;

    // Selection mode state
    let selectMode = false;
    const selectedIds = new Set();     // quick membership test
    const selectedOrder = [];          // stores ids in clicked order
    const songInfo = {};               // map id -> { name, folder } updated as we browse

    // ---------- Helpers ----------
    function naturalSortByName(a,b){
      return a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' });
    }

    function buildFileUrl(id){
      return `https://www.googleapis.com/drive/v3/files/${id}?alt=media&key=${API_KEY}`;
    }

    // ---------- Load folders & files ----------
    async function loadFolders(folderId) {
      folderGrid.innerHTML = "<p>Loading...</p>";
      playlistEl.innerHTML = "";

      const folderQuery = `'${folderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`;
      const audioQuery = `'${folderId}' in parents and mimeType contains 'audio/' and trashed=false`;

      const folderUrl = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(folderQuery)}&orderBy=name&fields=files(id,name)&key=${API_KEY}`;
      const filesUrl  = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(audioQuery)}&orderBy=name&fields=files(id,name)&key=${API_KEY}`;

      try {
        const [folderRes, fileRes] = await Promise.all([fetch(folderUrl), fetch(filesUrl)]);
        const [foldersData, filesData] = await Promise.all([folderRes.json(), fileRes.json()]);

        renderBreadcrumbs();

        const folders = (foldersData.files || []).sort((a,b) => a.name.localeCompare(b.name, undefined, { numeric:true, sensitivity:'base' }));
        const songs = (filesData.files || []).sort(naturalSortByName);

        // remember song info for selection persistence (folder = current folder name)
        const currentFolderName = folderStack[folderStack.length - 1].name;
        songs.forEach(s => {
          songInfo[s.id] = { name: s.name, folder: currentFolderName };
        });

        folderGrid.innerHTML = "";
        folders.forEach(folder => {
          const div = document.createElement("div");
          div.className = "folder";
          div.textContent = folder.name;
          div.onclick = () => {
            // navigate into folder -> keep selections (do not clear)
            folderStack.push({ id: folder.id, name: folder.name });
            loadFolders(folder.id);
          };
          folderGrid.appendChild(div);
        });

        // set current songs
        currentSongs = songs.map(f => ({ id: f.id, name: f.name }));
        renderPlaylist();
      } catch (err) {
        console.error("Error loading Drive data:", err);
        folderGrid.innerHTML = "<p style='color:#f88;'>Failed to load. Check API key / folder sharing.</p>";
      }
    }

    // ---------- Breadcrumbs ----------
    function renderBreadcrumbs(){
      breadcrumbs.innerHTML = "";
      folderStack.forEach((item, idx) => {
        if (idx > 0) breadcrumbs.appendChild(document.createTextNode(" / "));
        const btn = document.createElement("button");
        btn.textContent = item.name;
        btn.onclick = () => {
          // navigate back to this index, keep selections
          folderStack = folderStack.slice(0, idx + 1);
          loadFolders(item.id);
        };
        breadcrumbs.appendChild(btn);
      });
    }

    // ---------- Playlist rendering ----------
    function renderPlaylist(){
      playlistEl.innerHTML = "";
      if (!currentSongs || currentSongs.length === 0) {
        playlistEl.innerHTML = "<li style='padding:12px;color:var(--text-muted)'>No songs in this folder.</li>";
        return;
      }

      currentSongs.forEach((file, i) => {
        const li = document.createElement("li");
        li.dataset.id = file.id;
        li.textContent = file.name;

        // add subtle small id text
        const small = document.createElement("small");
        small.style.opacity = "0.35";
        small.style.marginLeft = "12px";
        small.textContent = file.id.slice(0,6);
        li.appendChild(small);

        // reflect selected / active state
        if (selectedIds.has(file.id)) li.classList.add("selected");
        if (i === currentTrackIndex) li.classList.add("active");

        li.onclick = (e) => {
          // if select mode -> toggle selection (persist globally)
          if (selectMode) {
            toggleSelect(file.id, file.name);
            // update visual immediately
            li.classList.toggle("selected", selectedIds.has(file.id));
            return;
          }
          // otherwise play
          playTrack(i);
        };

        playlistEl.appendChild(li);
      });
    }

    // ---------- Selection handling ----------
    function enterSelectMode(){
      selectMode = true;
      saveBtn.textContent = "ðŸ’¾ Save Selected";
      clearSelBtn.style.display = "inline-block";
      // show current selected visually on screen
      playlistEl.querySelectorAll("li").forEach(li => {
        li.classList.toggle("selected", selectedIds.has(li.dataset.id));
      });
    }

    function exitSelectMode(){
      selectMode = false;
      saveBtn.textContent = "ðŸ’¾ Save Playlist";
      clearSelBtn.style.display = "none";
      // remove selection visuals in current view (but keep selectedIds globally)
      playlistEl.querySelectorAll("li").forEach(li => li.classList.toggle("selected", selectedIds.has(li.dataset.id)));
    }

    function toggleSelect(id, name){
      if (selectedIds.has(id)) {
        selectedIds.delete(id);
        // remove from order array (first occurrence)
        const idx = selectedOrder.indexOf(id);
        if (idx !== -1) selectedOrder.splice(idx, 1);
      } else {
        selectedIds.add(id);
        selectedOrder.push(id);
        // ensure songInfo has name/folder (in case user selected from an imported playlist)
        if (!songInfo[id]) {
          // try to find name among currentSongs fallback
          const found = currentSongs.find(s => s.id === id);
          songInfo[id] = { name: found ? found.name : (name || "Unknown"), folder: folderStack[folderStack.length - 1].name };
        }
      }
    }

    function clearSelection(){
      selectedIds.clear();
      selectedOrder.length = 0;
      // clear visuals
      playlistEl.querySelectorAll("li").forEach(li => li.classList.remove("selected"));
    }

    // ---------- Playback ----------
    function playTrack(index){
      const file = currentSongs[index];
      if (!file) return;
      currentTrackIndex = index;
      // set source to Drive alt=media endpoint
      const fileURL = buildFileUrl(file.id);
      audioPlayer.src = fileURL;
      audioPlayer.play().catch(err => {
        console.warn("Playback failed:", err);
        retryPlay(fileURL);
      });
      // update active classes
      playlistEl.querySelectorAll("li").forEach((li, i) => {
        li.classList.toggle("active", i === index);
      });
    }

    function retryPlay(url, retries = 3){
      if (retries <= 0) {
        console.error("Failed to load audio after retries:", url);
        return;
      }
      setTimeout(() => {
        audioPlayer.src = url;
        audioPlayer.play().catch(()=> retryPlay(url, retries - 1));
      }, 3000);
    }

    audioPlayer.addEventListener("ended", () => {
      if (currentTrackIndex < currentSongs.length - 1) {
        playTrack(currentTrackIndex + 1);
      }
    });

    // ---------- Save button (toggle select mode / export selected) ----------
    saveBtn.addEventListener("click", () => {
      if (!selectMode) {
        // enter select mode
        enterSelectMode();
      } else {
        // export selected in order clicked (selectedOrder)
        if (selectedOrder.length === 0) {
          alert("No songs selected. Click songs to select them, then press Save Selected.");
          return;
        }
        // build array in order clicked with { name, id, folder }
        const payloadList = [];
        for (const id of selectedOrder) {
          const info = songInfo[id] || { name: "Unknown", folder: "Unknown" };
          payloadList.push({ name: info.name, id: id, folder: info.folder });
        }

        const payload = JSON.stringify({ songs: payloadList }, null, 2);
        const blob = new Blob([payload], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${folderStack.at(-1).name || "playlist"}.goot`;
        a.click();
        // after export, exit select mode and keep selections (but clear selection visuals)
        exitSelectMode();
      }
    });

    clearSelBtn.addEventListener("click", () => {
      if (!confirm("Clear all selected songs?")) return;
      clearSelection();
      exitSelectMode();
    });

    // ---------- Import (.goot) ----------
    loadBtn.addEventListener("click", () => importInput.click());
    importInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data.songs || !Array.isArray(data.songs)) throw new Error("Invalid .goot format");
          // set currentSongs to imported list (they contain {name,id,folder?})
          currentSongs = data.songs.map(s => ({ id: s.id, name: s.name }));
          // populate songInfo for playback and selection
          data.songs.forEach(s => {
            songInfo[s.id] = { name: s.name, folder: s.folder || "Imported" };
          });
          // set breadcrumb to indicate imported playlist
          folderStack = [{ id: ROOT_FOLDER_ID, name: "Imported Playlist" }];
          renderBreadcrumbs();
          folderGrid.innerHTML = ""; // hide folders visually
          exitSelectMode();
          renderPlaylist();
        } catch (err) {
          alert("Failed to load playlist file. Make sure it's a valid .goot (JSON).");
          console.error(err);
        }
      };
      reader.readAsText(file);
      // clear input so the same file can be reloaded later
      e.target.value = "";
    });

    // ---------- Init ----------
    loadFolders(ROOT_FOLDER_ID);
  </script>
</body>
</html>


